name: CD Pipeline (Deployment) - Version SimplifiÃ©e

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types: [completed]
    branches: [ main ]

permissions:
  contents: read
  packages: write

env:
  DOCKER_IMAGE_NAME: log430-labo3
  DOCKER_REGISTRY: ghcr.io
  REPO_NAME: monicadelao/log430-a25-labo3

jobs:
  # Job 1: Build et validation de l'image Docker
  deploy-docker:
    name: Build & Validation Docker
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.ref == 'refs/heads/main' }}
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        
      - name: Configuration Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Connexion au registre GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extraction des mÃ©tadonnÃ©es pour production
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.REPO_NAME }}/${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=main-
            type=raw,value=stable
            type=raw,value=production
            
      - name: Build et push image de production
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: Validation de l'image de production
        env:
          IMAGE_NAME: ${{ env.DOCKER_REGISTRY }}/${{ env.REPO_NAME }}/${{ env.DOCKER_IMAGE_NAME }}:production
        run: |
          echo "ğŸ” Validation de l'image Docker..."
          docker pull ${{ env.IMAGE_NAME }}
          
          echo "ğŸ“‹ Informations de l'image:"
          docker inspect ${{ env.IMAGE_NAME }} --format='{{.Config.Cmd}}'
          docker inspect ${{ env.IMAGE_NAME }} --format='{{.Config.WorkingDir}}'
          docker inspect ${{ env.IMAGE_NAME }} --format='{{.Config.ExposedPorts}}'
          
          echo "âœ… Image de production validÃ©e et prÃªte pour le dÃ©ploiement"

  # Job 2: GÃ©nÃ©ration du rapport de dÃ©ploiement
  deployment-report:
    name: Rapport de DÃ©ploiement
    runs-on: ubuntu-latest
    needs: deploy-docker
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        
      - name: GÃ©nÃ©ration du rapport de dÃ©ploiement
        run: |
          echo "# ğŸ“Š Rapport de DÃ©ploiement LOG430 Labo3" > deployment-report.md
          echo "" >> deployment-report.md
          echo "**Date:** $(date)" >> deployment-report.md
          echo "**Commit:** ${{ github.sha }}" >> deployment-report.md
          echo "**Branche:** ${{ github.ref_name }}" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "## âœ… Statut du Pipeline" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "- âœ… Tests et QualitÃ© de Code: **PASSÃ‰**" >> deployment-report.md
          echo "- âœ… Build Docker: **PASSÃ‰**" >> deployment-report.md
          echo "- âœ… Scan de SÃ©curitÃ©: **PASSÃ‰**" >> deployment-report.md
          echo "- âœ… Push vers Registry: **PASSÃ‰**" >> deployment-report.md
          echo "- âœ… Validation Image: **PASSÃ‰**" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "## ğŸ³ Image Docker" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "- **Registry:** \`${{ env.DOCKER_REGISTRY }}\`" >> deployment-report.md
          echo "- **Image:** \`${{ env.REPO_NAME }}/${{ env.DOCKER_IMAGE_NAME }}:production\`" >> deployment-report.md
          echo "- **Taille:** Consultez les logs du build" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "## ğŸš€ Instructions de DÃ©ploiement" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### DÃ©ploiement Local (TestÃ© âœ…)" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "\`\`\`bash" >> deployment-report.md
          echo "git clone https://github.com/${{ github.repository }}.git" >> deployment-report.md
          echo "cd log430-a25-labo3" >> deployment-report.md
          echo "docker-compose up -d" >> deployment-report.md
          echo "curl http://localhost:5000/health" >> deployment-report.md
          echo "\`\`\`" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### DÃ©ploiement VM (10.194.32.238)" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "\`\`\`bash" >> deployment-report.md
          echo "# Se connecter Ã  la VM" >> deployment-report.md
          echo "ssh log430@10.194.32.238" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "# CrÃ©er le rÃ©pertoire de dÃ©ploiement" >> deployment-report.md
          echo "mkdir -p ~/log430-labo3-deploy && cd ~/log430-labo3-deploy" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "# TÃ©lÃ©charger la configuration" >> deployment-report.md
          echo "curl -o docker-compose.yml https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/docker-compose.yml" >> deployment-report.md
          echo "curl -o init.sql https://raw.githubusercontent.com/${{ github.repository }}/main/db-init/init.sql" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "# DÃ©marrer l'application" >> deployment-report.md
          echo "docker compose up -d" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "# VÃ©rifier le dÃ©ploiement" >> deployment-report.md
          echo "curl http://localhost:5000/health" >> deployment-report.md
          echo "\`\`\`" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "## ğŸ”— Liens Utiles" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "- [Code Source](https://github.com/${{ github.repository }})" >> deployment-report.md
          echo "- [Docker Registry](https://github.com/${{ github.repository }}/pkgs/container/${{ env.DOCKER_IMAGE_NAME }})" >> deployment-report.md
          echo "- [Actions GitHub](https://github.com/${{ github.repository }}/actions)" >> deployment-report.md
          echo "- [Tests d'acceptation locaux](https://github.com/${{ github.repository }}/blob/main/scripts/acceptance_tests.py)" >> deployment-report.md
          
          echo "ğŸ“‹ Rapport gÃ©nÃ©rÃ© avec succÃ¨s!"
          cat deployment-report.md
          
      - name: Upload du rapport comme artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.md
          retention-days: 30

  # Job 3: Notification de succÃ¨s
  notify-success:
    name: âœ… DÃ©ploiement TerminÃ©
    runs-on: ubuntu-latest
    needs: [deploy-docker, deployment-report]
    if: success()
    
    steps:
      - name: RÃ©sumÃ© du dÃ©ploiement complet
        run: |
          echo "ğŸ‰ **DÃ‰PLOIEMENT CI/CD TERMINÃ‰ AVEC SUCCÃˆS!** ğŸ‰"
          echo ""
          echo "âœ… Image Docker buildÃ©e et pushÃ©e vers GHCR"
          echo "âœ… Tests d'acceptation validÃ©s localement"
          echo "âœ… Application fonctionnelle en Docker Compose"
          echo "âœ… Rapport de dÃ©ploiement gÃ©nÃ©rÃ©"
          echo ""
          echo "ğŸŒ **Application accessible localement sur:** http://localhost:5000"
          echo "ğŸ“‹ **Prochaines Ã©tapes:** Utilisez le rapport de dÃ©ploiement pour la VM"
          echo ""
          echo "ğŸ† **Laboratoire LOG430 complÃ©tÃ© avec succÃ¨s!**"